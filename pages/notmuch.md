---
title: Notmuch - чудесная почта в Emacs
---

# Notmuch - чудесная почта в Emacs {#notmuch}

Некогда я предпринимала попытки освоиться с несколькими емаксовыми почтовыми клиентами, но они не прижились совершенно. Может, мне чего не хватало, может, им. Не помню. Пыталась использовать всякие прочие.  Предпоследняя попытка - sup-mail. Но сейчас я, кажется, нашла, что хотела. Notmuch. И это в первую очередь поисковичок, умеющий метки. На движке xapian. С интерфейсом для emacs.

<!-- more --> 

-   Мои этак 50 тысяч писем - вообще не напрягают. Поиск по адресам, поиск по текстам, поиск по сабжам, поиск по тегам… — влёт. Удаление больших количеств — не совсем влёт, но «запустила команду и чуток подождала», а не кнопочки натыкивать.

-   Распознаёт дубли, умеет обращаться с ними как с одним письмом.

-   Notmuch не пытается лезть в интернет сам. И это офигенно правильно, потому что интернет разный бывает. А емакс мне нужен - реагирующий.  Почту я получаю mbsync(isync)-ом, отправляю через exim. В общем-то, и для написания почты используются существующие возможности emacs (собстно, message-mode), и замечательно, ибо нефиг изобретать уже изобретённые колёса.

-   Notmuch позволяет мне обращаться с почтой удобно. Так, я уже практически убрала “входящие обыкновенные неразобранные”. Аналог инбокса лично у меня - “почта за вчера и сегодня”, сохранённый поиск по датам. Это всегда немного. ) Если мне нужно что-то более раннее - не вопрос, но глаза оно не мозолит. И вообще не возникает тоски от неразобранной почты.

-   Неплохо читает html-ную почту. Не передаёт красот оформления, и хорошо - там часто уйма лишнего. Но вполне читает и отвечает. Это, кстати, было проблемой раньше - либо неудобный подход, либо только текстовая почта.

Что для этого было нужно?

-   Из дебианного репозитория я поставила `notmuch` (`sudo aptitude install notmuch`, есличо).

-   при помощи `elpa` - `notmuch-emacs`. Он есть и в репах дебиана, но в `elpa` обновляется почаще )

-   Сконвертила всё, что хранилось в `mbox`-ах в `maildir`-ы - `mb2md` в дебианном репозитории тоже есть.

-   Убедилась, что procmail локальную почту тоже доставляет в `maildir`.

-   Запустила `notmuch-setup`, ответила на вопросы:

    -   где папка с почтой

    -   как меня звать

    -   какая почта у меня основная

    -   какие ещё есть

    -   какие теги добавлять новым письмам (у меня сейчас - `unread;inbox;new`)

    -   какие папки и файлы игнорировать в папке с почтой (у меня - никакие)

    -   письма с какими тегами исключать из поисков (у меня - `spam;deleted;muted`. Последний - на случай рассылок, в которых не захочется видеть какой-то тред. Для этого же `notmuch tag -inbox +muted -- "$(notmuch search --output=threads tag:muted);` в `post-new`, о котором чуть ниже)

    -   синхронизировать ли флаги в именах файлов с тегами (да)

-   Посмотрела на полученный `~/.notmuch-config`, убедилась, что он меня устраивает.

-   Сказала `notmuch new` в консольке. Так notmuch ознакомился с моей почтой.

-   Сказала `M-x notmuch` в емаксе, и получила приветственное окошко.

-   Затем было и всё ещё продолжается развлечение с настройкой и доводкой тегов. Путём правки файлика `$DATABASEDIR/.notmuch/hooks/post-new` для сортировки входящей почты, и путём запуска поисков в консольке для разметки уже существующей почты. Основная разница в том, что в файлике это обычно `notmuch +something -new -inbox -- tag:new and some-other-search-terms`, а в консольке -new и tag:new не фигурируют. Пока что всей сортировки - жалких 100 строк, у людей, пишуть, куда как побольше.

    Интересно видеть, сколько чего. Временами даже странно, когда понимаешь, насколько мало или много места что-то занимает в почтовом ящике и в жизни.

    Временами прекрасный стимул отписаться от рассылок. Тех, которых много, но которые даже не трудишься открывать...

## Как оно у меня

На входящие назначается тег `inbox`, далее работает хук `post-new`, который разбирает «знакомые» письма по другим тегам, тег `inbox` снимая.

Частично это спам, разумеется. Частично то, для чего нужно сделать назначение тегов. Частично то, что разбираю вручную. Но всё, что требует быстрого реагирования - разбирается как «вчерашне-сегодняшнее». Возня с неразобранными входящими - это «на что надо назначить теги», «какой спам мне было лень удалить сразу», «какие единичные письма и почему застряли». Где-то месяца через два использования - предприняла, было легко. А сейчас как-то всё на лету разбирается, вообще не напрягает.

Просматриваю, в основном, или то, что сейчас нужно по теме, или поиск «вчерашнее-сегодняшнее». В поиске по умолчанию не показываются «удалённые» письма и помеченные как спам, что есть стимул их помечать и удалять.

Для того, на что отреагировать таки надо, но слабО сразу - я не уверена, что сделаю за «вчера-сегодня», есть специальная метка `todo`, вынесена в сохранённые поиски наряду с `flagged` (что на мой взгляд стоит перечитать когда-нибудь).

## Полезняшки

-   Отправлять письма - `M-x notmuch-mua-send`. Привязывать кнопочки - своими силами, в меню не торчит, несколько неочевидно.

-   создание нового письма - `m` в любом из notmuch-евских буферов.

-   есть `org-notmuch`, умеет делать ссылки на notmuch-евские письма и поиски. Мне крайне удобно, потому что часть сведений по работе приходит почтой, и удобно делать ссылку из рабочего файла.

-   аттачи смотреть - `. o` - тогда запросит, чем. Или `. v` - тогда поумолчательной.

-   если хочется поменять внешние смотрелки для `. v` - это надо править `.mailcap` в домашнем каталоге. Может быть, его для этого надо завести. Я заводила раньше и по другому поводу.  `$HOME/.mailcap:/etc/mailcap:/usr/share/etc/mailcap:/usr/local/etc/mailcap` - адреса, по которым стоит его у себя высматривать.

-   По `?` выводит подсказку, какие тут есть основные кнопочки.  Поведение традиционное, но от этого не менее приятное.

-   После каждого получения почты надо снова командовать `notmuch new`. Поэтому завела алиас в `.bashrc`на вот такое `mbsync mymail && notmuch new`. Просто чтоб и не помнить.

-   `notmuch search --output=files tag:deleted` - получить список файлов, отмеченных тегом deleted

-   `notmuch search --format=text0 --output=files tag:deleted | xargs -0 --no-run-if-empty rm}` или `notmuch search --output=files tag:deleted | tr '\n' '\0' | xargs -0 -L 1 rm}` - удалить такие файлы. Понятно, можно и что-то другое делать по тому же принципу.

А в `custom-set-variables` файла `init.el` у меня, кроме сохранённых поисков, завелось следующее:

    '(message-confirm-send t)
    '(message-interactive nil)
    '(send-mail-function (quote sendmail-send-it))

### Ссылки {#notmuch-links}

-   https://notmuchmail.org/ - сайт notmuch

-   http://notmuch.198994.n3.nabble.com/ - их рассылка форумом.


